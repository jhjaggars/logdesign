# Global IAM Role for Multi-Tenant Logging

This directory contains the CloudFormation template for deploying the global central log distribution role that enables cross-account access for the multi-tenant logging infrastructure.

## Overview

The global deployment creates a single IAM role that serves as the central hub for cross-account log delivery across all regions and customer accounts. This role is designed to be deployed once per AWS account and used by all regional deployments.

## Template

### `central-log-distribution-role.yaml`
Creates the central IAM role that enables secure cross-account access to customer log destinations.

**Key Features**:
- **Global Scope**: One role serves all regions and customers
- **Cross-Account Access**: Can assume customer roles with ExternalId validation
- **Lambda Integration**: Can be assumed by Lambda execution roles
- **Service Integration**: Supports both Lambda and container-based processors

## Architecture Role

The global role sits at the center of the multi-tenant logging security model:

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Regional       │    │   Global         │    │   Customer      │
│  Lambda/        │───▶│   Central        │───▶│   Log           │
│  Processor      │    │   Distribution   │    │   Distribution  │
│  Role           │    │   Role           │    │   Role          │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

1. **Regional processors** assume the global central role
2. **Global central role** assumes customer-specific roles  
3. **Customer roles** provide CloudWatch Logs access in customer accounts

## Prerequisites

- AWS account with IAM permissions to create roles
- Understanding of cross-account role assumption patterns
- Planning for random suffix generation and management

## Deployment

### Basic Deployment

```bash
# Deploy the global central role
./deploy.sh -t global

# Stack name will be: multi-tenant-logging-global
# Role name will be: ROSA-CentralLogDistributionRole-{random-suffix}
```

### With Custom Parameters

```bash
# Deploy with custom project name
./deploy.sh -t global -p my-logging-project

# Stack name will be: my-logging-project-global  
# Role name will be: ROSA-CentralLogDistributionRole-{random-suffix}
```

### Parameters

| Parameter | Description | Required | Default |
|-----------|-------------|----------|---------|
| `ProjectName` | Project name for resource naming | No | `multi-tenant-logging` |
| `RandomSuffix` | Random suffix for unique naming | Yes | Generated by deploy script |

## Role Permissions

The central log distribution role has minimal permissions focused on cross-account access:

### AssumeRole Policy
```json
{
  "Version": "2012-10-17", 
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT:root"
      },
      "Action": "sts:AssumeRole"
    },
    {
      "Effect": "Allow", 
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

### Managed Policies
- `AWSLambdaBasicExecutionRole` - For CloudWatch Logs when used by Lambda
- `AWSLambdaSQSQueueExecutionRole` - For SQS integration when used by Lambda

### Custom Policies
- **CrossAccountAssumeRolePolicy**: Can assume customer roles matching pattern `CustomerLogDistribution-*`
- **ExternalId Validation**: Requires ExternalId matching the central AWS account ID
- **XRay Integration**: Can write traces for observability

## Stack Outputs

The global stack provides these key outputs for use by regional deployments:

### `CentralLogDistributionRoleArn`
**Purpose**: ARN of the central role for regional deployments to reference
**Usage**: Required parameter for all [regional deployments](../regional/)
**Example**: `arn:aws:iam::123456789012:role/ROSA-CentralLogDistributionRole-abcd1234`

### `CentralLogDistributionRoleName`  
**Purpose**: Role name for customer role trust policies
**Usage**: Reference in [customer deployment](../customer/) trust relationships
**Example**: `ROSA-CentralLogDistributionRole-abcd1234`

### `RandomSuffix`
**Purpose**: The random suffix used for unique resource naming
**Usage**: Consistent naming across related stacks and resources
**Example**: `abcd1234`

## Integration with Other Deployments

### Regional Integration
Regional deployments require the central role ARN as a parameter:

```bash
# Regional deployment references global role
./deploy.sh -t regional \
  -b my-templates-bucket \
  --central-role-arn arn:aws:iam::123456789012:role/ROSA-CentralLogDistributionRole-abcd1234
```

### Customer Integration  
Customer deployments create roles that trust the central role:

```bash
# Customer deployment trusts global role
./deploy.sh -t customer \
  --central-role-arn arn:aws:iam::123456789012:role/ROSA-CentralLogDistributionRole-abcd1234
```

### Cluster Integration
Cluster deployments may reference the central role for processor functions:

```bash
# Cluster processor role for cross-account delivery
./deploy.sh -t cluster \
  --cluster-name my-cluster \
  --central-role-arn arn:aws:iam::123456789012:role/ROSA-CentralLogDistributionRole-abcd1234
```

## Security Model

### ExternalId Validation
The central role uses ExternalId validation for additional security:

- **ExternalId**: Always the central AWS account ID
- **Purpose**: Prevents confused deputy attacks
- **Implementation**: Customer roles must include matching ExternalId condition

### Cross-Account Pattern
The role implements a secure cross-account access pattern:

1. **Central role** is assumed by regional processors
2. **Central role** assumes customer roles with ExternalId validation
3. **Customer roles** provide minimal CloudWatch Logs permissions
4. **Audit trail** maintained through CloudTrail for all role assumptions

### Least Privilege
- **No direct AWS service permissions** except basic Lambda execution
- **Only AssumeRole permissions** for customer roles
- **Pattern-based customer role matching** to prevent unauthorized access
- **ExternalId requirements** for all customer role assumptions

## Deployment Order

The global role must be deployed before other stack types:

1. **First**: Deploy global stack (this directory)
2. **Second**: Deploy [regional stacks](../regional/) using global role ARN
3. **Third**: Deploy [customer stacks](../customer/) trusting global role
4. **Fourth**: Deploy [cluster stacks](../cluster/) referencing global role (if needed)

## Maintenance and Updates

### Updating the Global Role
```bash
# Update existing global deployment
./deploy.sh -t global

# The random suffix is preserved during updates
# Role ARN remains stable for existing integrations
```

### Role ARN Discovery
```bash
# Get the role ARN for use in other deployments
aws cloudformation describe-stacks \
  --stack-name multi-tenant-logging-global \
  --query 'Stacks[0].Outputs[?OutputKey==`CentralLogDistributionRoleArn`].OutputValue' \
  --output text
```

### Validation
```bash
# Validate global template
./deploy.sh -t global --validate-only

# Test role assumption (from regional account)
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/ROSA-CentralLogDistributionRole-abcd1234 \
  --role-session-name test-assumption
```

## Troubleshooting

### Common Issues

1. **Role Already Exists Error**
   - Check if role was created manually
   - Verify random suffix uniqueness
   - Use `--dry-run` to preview changes

2. **Cannot Assume Role**
   - Verify regional processor role has correct assume permissions
   - Check role trust policy allows regional account principals
   - Confirm role ARN is correct in regional deployment

3. **Customer Role Assumption Fails**
   - Verify customer role trust policy includes central role ARN
   - Check ExternalId condition in customer role
   - Confirm customer role name matches pattern `CustomerLogDistribution-*`

### Debugging Commands

```bash
# Check role details
aws iam get-role --role-name ROSA-CentralLogDistributionRole-abcd1234

# List role policies
aws iam list-attached-role-policies --role-name ROSA-CentralLogDistributionRole-abcd1234
aws iam list-role-policies --role-name ROSA-CentralLogDistributionRole-abcd1234

# Test role assumption from another account
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/ROSA-CentralLogDistributionRole-abcd1234 \
  --role-session-name debug-test \
  --external-id 123456789012
```

## Cost Considerations

- **No Ongoing Costs**: IAM roles have no charges for existence or usage
- **CloudTrail Events**: Role assumptions generate CloudTrail events (standard CloudTrail charges apply)
- **Cross-Account Calls**: STS AssumeRole calls are free
- **Regional Independence**: Single global role eliminates per-region role costs

## Best Practices

1. **Single Global Deployment**: Deploy once per central AWS account
2. **Stable Role ARN**: Preserve random suffix across updates for stable integrations
3. **Monitoring**: Monitor role usage through CloudTrail
4. **Documentation**: Document role ARN for team access and automation
5. **Access Control**: Restrict who can modify the global role stack

## Related Documentation

- **[Regional Deployment](../regional/)** - Uses global role ARN as parameter
- **[Customer Deployment](../customer/)** - Trusts global role for cross-account access
- **[Cluster Deployment](../cluster/)** - May reference global role for processor functions
- **[Main Documentation](../)** - Complete architecture overview and deployment workflows

## Support

For global role issues:
1. Verify IAM permissions for role creation and management
2. Check CloudTrail for role assumption events and failures
3. Validate role trust policies and attached permissions
4. Consult AWS IAM documentation for cross-account access patterns